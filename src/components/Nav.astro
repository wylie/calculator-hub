---
import CalculatorSearchBar from './CalculatorSearchBar.tsx';
import { generatedCalculators } from '../react-pages/Generated/generatedCalculatorData';

interface NavItem {
  path: string;
  label: string;
}

interface NavCategory {
  label: string;
  path: string;
  items: NavItem[];
}

interface NavSubcategory {
  label: string;
  items: NavItem[];
}

interface TopLevelNavCategory {
  label: string;
  path: string;
  subcategories: NavSubcategory[];
}

const currentPath = Astro.url.pathname;

const normalizeLabel = (title: string): string => title.replace(/\s+Calculator$/i, '').trim();

const makeGeneratedItems = (categories: string[]): NavItem[] => {
  return generatedCalculators
    .filter((calculator) => categories.includes(calculator.category))
    .map((calculator) => ({
      path: `/${calculator.slug}`,
      label: normalizeLabel(calculator.title),
    }));
};

const uniqueItems = (items: NavItem[]): NavItem[] => {
  return items.filter((item, index, arr) => arr.findIndex((other) => other.path === item.path) === index);
};

const sortItemsAlphabetically = (items: NavItem[]): NavItem[] => {
  return [...items].sort((left, right) => left.label.localeCompare(right.label, undefined, { sensitivity: 'base' }));
};

const generatedLoansItems = makeGeneratedItems(['loans', 'home']);
const generatedBudgetingItems = makeGeneratedItems(['income']);
const generatedHealthItems = makeGeneratedItems(['health', 'outdoors']);
const generatedSavingsItems = makeGeneratedItems(['savings']);
const generatedConvertersItems = makeGeneratedItems(['percentages', 'time', 'converters']);

const navCategoriesBase: NavCategory[] = [
  {
    label: 'Loans & Real Estate',
    path: '/loans',
    items: [
      { path: '/mortgage', label: 'Mortgage' },
      { path: '/auto-loan', label: 'Auto Loan' },
      { path: '/loan', label: 'Loan' },
      { path: '/loan-affordability', label: 'Loan Affordability' },
      { path: '/refinance', label: 'Refinance' },
      { path: '/down-payment', label: 'Down Payment' },
      { path: '/rent-vs-buy', label: 'Rent vs Buy' },
      { path: '/personal-loan', label: 'Personal Loan' },
      { path: '/student-loan', label: 'Student Loan' },
      { path: '/debt-snowball', label: 'Debt Snowball' },
      { path: '/debt-avalanche', label: 'Debt Avalanche' },
      { path: '/heloc', label: 'HELOC' },
      { path: '/amortization-calculator', label: 'Amortization Schedule' },
      { path: '/loan-payment-calculator', label: 'Loan Payment' },
      { path: '/property-tax', label: 'Property Tax' },
      { path: '/closing-cost', label: 'Closing Cost' },
      { path: '/pmi', label: 'PMI' },
      { path: '/home-equity', label: 'Home Equity' },
      { path: '/rent-increase', label: 'Rent Increase' },
      { path: '/rental-yield', label: 'Rental Yield' },
    ],
  },
  {
    label: 'Savings & Investment',
    path: '/savings-investment',
    items: [
      { path: '/interest', label: 'Interest' },
      { path: '/compound-interest', label: 'Compound Interest' },
      { path: '/investment-growth', label: 'Investment Growth' },
      { path: '/retirement', label: 'Retirement' },
      { path: '/savings', label: 'Savings' },
      { path: '/inflation', label: 'Inflation' },
      { path: '/emergency-fund', label: 'Emergency Fund' },
      { path: '/roi', label: 'ROI' },
    ],
  },
  {
    path: '/budgeting',
    label: 'Budgeting & Finance',
    items: [
      { path: '/budget', label: 'Budget' },
      { path: '/credit-card-payoff', label: 'Credit Card Payoff' },
      { path: '/net-worth', label: 'Net Worth' },
      { path: '/debt-to-income', label: 'Debt-to-Income' },
      { path: '/tax', label: 'Tax' },
      { path: '/salary-hourly', label: 'Salary / Hourly' },
      { path: '/hourly-to-salary', label: 'Hourly to Salary' },
      { path: '/overtime-pay', label: 'Overtime Pay' },
      { path: '/take-home-pay', label: 'Take-Home Pay' },
      { path: '/after-tax-salary', label: 'After-Tax Salary' },
      { path: '/pay-raise', label: 'Pay Raise' },
      { path: '/annual-income', label: 'Annual Income' },
      { path: '/biweekly-pay', label: 'Biweekly Pay' },
      { path: '/monthly-income', label: 'Monthly Income' },
      { path: '/self-employment-tax', label: 'Self-Employment Tax' },
      { path: '/1099-vs-w2', label: '1099 vs W2' },
      { path: '/discount', label: 'Discount / Markup' },
      { path: '/cost-of-living-calculator', label: 'Cost of Living' },
    ],
  },
  {
    path: '/health',
    label: 'Health & Lifestyle',
    items: [
      { path: '/calories', label: 'Calories' },
      { path: '/bmi', label: 'BMI' },
      { path: '/tdee', label: 'TDEE' },
      { path: '/ideal-weight', label: 'Ideal Weight' },
      { path: '/water-intake', label: 'Water Intake' },
      { path: '/protein-intake', label: 'Protein Intake' },
      { path: '/age', label: 'Age' },
      { path: '/tip', label: 'Tip' },
      { path: '/bike-gear', label: 'Bike Gear' },
      { path: '/cycling-power-to-weight', label: 'Power-to-Weight' },
      { path: '/tire-pressure', label: 'Tire Pressure' },
      { path: '/hiking-pace', label: 'Hiking Pace' },
      { path: '/calories-cycling', label: 'Calories Cycling' },
      { path: '/fuel-efficiency', label: 'Fuel Efficiency' },
      { path: '/gpa', label: 'GPA Calculator' },
      { path: '/body-fat', label: 'Body Fat' },
      { path: '/lean-body-mass', label: 'Lean Body Mass' },
      { path: '/macro-calculator', label: 'Macro' },
      { path: '/calories-burned', label: 'Calories Burned' },
      { path: '/one-rep-max', label: 'One Rep Max' },
      { path: '/target-heart-rate', label: 'Target Heart Rate' },
      { path: '/cycling-ftp', label: 'Cycling FTP' },
      { path: '/vo2-max', label: 'VO2 Max' },
      { path: '/trail-elevation-gain', label: 'Trail Elevation Gain' },
      { path: '/pace-per-mile', label: 'Pace Per Mile' },
    ],
  },
  {path: '/converters',
    
    label: 'Converters & Tools',
    items: [
      { path: '/weather', label: 'Temperature' },
      { path: '/weight', label: 'Weight' },
      { path: '/height-converter', label: 'Height' },
      { path: '/distance-converter', label: 'Distance' },
      { path: '/length', label: 'Length' },
      { path: '/speed', label: 'Speed' },
      { path: '/volume', label: 'Volume' },
      { path: '/area', label: 'Area' },
      { path: '/time', label: 'Time' },
      { path: '/time-duration', label: 'Time Duration' },
      { path: '/cooking-converter', label: 'Cooking' },
      { path: '/power-converter', label: 'Power' },
      { path: '/file-size', label: 'File Size' },
      { path: '/percentage', label: 'Percentage' },
      { path: '/percentage-of-a-number', label: 'Percentage of a Number' },
      { path: '/what-percent-of-x-is-y', label: 'What Percent of X is Y' },
      { path: '/fraction-to-percent', label: 'Fraction to Percent' },
      { path: '/percent-to-fraction', label: 'Percent to Fraction' },
      { path: '/margin-calculator', label: 'Margin' },
      { path: '/markup-calculator', label: 'Markup' },
      { path: '/percentage-increase', label: 'Percentage Increase' },
      { path: '/percentage-decrease', label: 'Percentage Decrease' },
      { path: '/percent-change', label: 'Percent Change' },
      { path: '/date-difference', label: 'Date Difference' },
      { path: '/work-hours', label: 'Work Hours' },
      { path: '/business-days', label: 'Business Days' },
      { path: '/countdown', label: 'Countdown' },
      { path: '/week-number', label: 'Week Number' },
      { path: '/time-zone-converter', label: 'Time Zone Converter' },
      { path: '/climbing-grade-converter', label: 'Climbing Grade Converter' },
    ],
  },
];

const legacyNavCategories: NavCategory[] = navCategoriesBase.map((category) => {
  let generatedItems: NavItem[] = [];

  if (category.path === '/loans') {
    generatedItems = generatedLoansItems;
  } else if (category.path === '/budgeting') {
    generatedItems = generatedBudgetingItems;
  } else if (category.path === '/health') {
    generatedItems = generatedHealthItems;
  } else if (category.path === '/savings-investment') {
    generatedItems = generatedSavingsItems;
  } else if (category.path === '/converters') {
    generatedItems = generatedConvertersItems;
  }

  return {
    ...category,
    items: sortItemsAlphabetically(uniqueItems([...category.items, ...generatedItems])),
  };
});

const legacyItemsByPath = new Map(legacyNavCategories.map((category) => [category.path, category.items]));

const getLegacyItems = (path: string): NavItem[] => legacyItemsByPath.get(path) ?? [];

const buildSubcategories = (
  pool: NavItem[],
  definitions: Array<{ label: string; matcher: (item: NavItem) => boolean }>
): NavSubcategory[] => {
  let remaining = sortItemsAlphabetically(uniqueItems(pool));

  const subcategories = definitions.map((definition) => {
    const matched = remaining.filter(definition.matcher);
    const matchedPaths = new Set(matched.map((item) => item.path));
    remaining = remaining.filter((item) => !matchedPaths.has(item.path));

    return {
      label: definition.label,
      items: sortItemsAlphabetically(uniqueItems(matched)),
    };
  });

  if (remaining.length > 0 && subcategories.length > 0) {
    const lastIndex = subcategories.length - 1;
    subcategories[lastIndex] = {
      ...subcategories[lastIndex],
      items: sortItemsAlphabetically(uniqueItems([...subcategories[lastIndex].items, ...remaining])),
    };
  }

  return subcategories.filter((subcategory) => subcategory.items.length > 0);
};

const staticConvertersItems = navCategoriesBase.find((category) => category.path === '/converters')?.items ?? [];

const conversionBaseItems = staticConvertersItems.filter((item) =>
  /(weather|temperature|weight|height|distance|length|speed|volume|area|time|time-duration|cooking-converter|power-converter|file-size)/.test(item.path)
);

const conversionPool = uniqueItems([...conversionBaseItems, ...makeGeneratedItems(['converters'])]);

const toolsPool = uniqueItems([
  ...makeGeneratedItems(['percentages', 'time']),
  ...staticConvertersItems.filter((item) =>
    /(percent|percentage|date-difference|work-hours|business-days|countdown|week-number|time-zone|climbing-grade)/.test(item.path)
  ),
  ...getLegacyItems('/budgeting').filter((item) => /(cost-of-living|discount|budget|expense|profit|break-even)/.test(item.path)),
  ...getLegacyItems('/savings-investment').filter((item) => /(emergency-fund)/.test(item.path)),
]);

const topLevelNav: TopLevelNavCategory[] = [
  {
    label: 'Money',
    path: '/money',
    subcategories: buildSubcategories(
      uniqueItems([...getLegacyItems('/budgeting'), ...getLegacyItems('/savings-investment')]),
      [
        {
          label: 'Income & Paychecks',
          matcher: (item) =>
            /(income|salary|hourly|pay|1099|w2|commission|bonus|severance|freelance)/.test(item.path),
        },
        {
          label: 'Budgeting',
          matcher: (item) => /(budget|cost-of-living|expense|net-worth|cash-flow|unit-price)/.test(item.path),
        },
        {
          label: 'Debt & Credit',
          matcher: (item) => /(debt|credit|utilization|consolidation|balance-transfer|payoff)/.test(item.path),
        },
        {
          label: 'Taxes',
          matcher: (item) => /(tax|after-tax|self-employment)/.test(item.path),
        },
        {
          label: 'Retirement',
          matcher: (item) => /(retirement|401k|ira|required-minimum-distribution|roth|traditional)/.test(item.path),
        },
        {
          label: 'Savings & Investing',
          matcher: (item) =>
            /(savings|interest|investment|inflation|roi|return|portfolio|stock|dividend|cd|annuity|future-value|present-value|rule-of-72|capital-gains)/.test(item.path),
        },
      ]
    ),
  },
  {
    label: 'Loans & Home',
    path: '/loans',
    subcategories: buildSubcategories(getLegacyItems('/loans'), [
      {
        label: 'Mortgage',
        matcher: (item) => /(mortgage|pmi|amortization|loan-payment-calculator|loan-term)/.test(item.path),
      },
      {
        label: 'Refinance',
        matcher: (item) => /(refinance)/.test(item.path),
      },
      {
        label: 'Personal / Auto / Student Loans',
        matcher: (item) => /(personal-loan|auto-loan|student-loan|business-loan|loan$)/.test(item.path),
      },
      {
        label: 'Affordability',
        matcher: (item) => /(affordability)/.test(item.path),
      },
      {
        label: 'Home Equity',
        matcher: (item) => /(heloc|home-equity|home-appreciation)/.test(item.path),
      },
      {
        label: 'Rent vs Buy',
        matcher: (item) => /(rent-vs-buy|rent-vs-invest|rent-increase|rental-yield|rental-cash-flow)/.test(item.path),
      },
      {
        label: 'Property Costs',
        matcher: (item) => /(property-tax|closing-cost|down-payment|property-value-estimator)/.test(item.path),
      },
    ]),
  },
  {
    label: 'Health & Fitness',
    path: '/health',
    subcategories: buildSubcategories(getLegacyItems('/health'), [
      {
        label: 'Body Metrics',
        matcher: (item) => /(bmi|body-fat|lean-body-mass|ideal-weight|bmr|vo2-max)/.test(item.path),
      },
      {
        label: 'Nutrition',
        matcher: (item) => /(calories|protein|water|tdee|macro|calorie-deficit|resting-metabolic-rate|tip)/.test(item.path),
      },
      {
        label: 'Activity & Performance',
        matcher: (item) =>
          /(bike|cycling|hiking|pace|heart-rate|one-rep-max|steps-to-miles|tire-pressure|fuel-efficiency|sleep|running-calories-burned|trail-elevation-gain|gpa|age|pregnancy-due-date)/.test(item.path),
      },
    ]),
  },
  {
    label: 'Conversions',
    path: '/converters',
    subcategories: buildSubcategories(conversionPool, [
      {
        label: 'Unit Converters',
        matcher: (item) =>
          /(weight|height|distance|length|speed|volume|area|power-converter|file-size|cooking-converter|voltage|density|pressure)/.test(item.path),
      },
      {
        label: 'Temperature',
        matcher: (item) => /(weather|temperature-feels-like)/.test(item.path),
      },
      {
        label: 'Time & Date',
        matcher: (item) => /(time|date|hours-to-days|months-between-dates|days-until)/.test(item.path),
      },
      {
        label: 'Percentage Conversions',
        matcher: (item) => /(percentage-of-a-number|what-percent-of-x-is-y|fraction-to-percent|percent-to-fraction|percentage$)/.test(item.path),
      },
    ]),
  },
  {
    label: 'Tools & Planning',
    path: '/tools-planning',
    subcategories: buildSubcategories(toolsPool, [
      {
        label: 'Percentage & Change',
        matcher: (item) => /(percent|percentage|margin|markup|discount|break-even|profit)/.test(item.path),
      },
      {
        label: 'Work & Business Time',
        matcher: (item) =>
          /(work-hours|business-days|countdown|week-number|time-zone|workdays-between-dates|time-card|hours-worked|days-until|months-between-dates|hours-to-days)/.test(item.path),
      },
      {
        label: 'Cost of Living & Planning',
        matcher: (item) => /(cost-of-living|emergency-fund|budget|expense|cash-flow|climbing-grade)/.test(item.path),
      },
    ]),
  },
];

const isActive = (path: string) => currentPath === path;
const isCategoryActive = (items: NavItem[]) => items.some((item) => isActive(item.path));
const isTopLevelCategoryActive = (category: TopLevelNavCategory) =>
  isActive(category.path) || category.subcategories.some((subcategory) => isCategoryActive(subcategory.items));

const getDesktopDropdownStyle = (): string => {
  return 'width: min(700px, calc(100vw - 2rem)); max-width: calc(100vw - 2rem); max-height: min(80vh, 700px); overflow-y: auto; overflow-x: hidden;';
};
---

<nav class="bg-white border-b border-slate-200 shadow-sm">
  <div class="max-w-7xl mx-auto px-6">
    <!-- Site Name Row -->
    <div class="flex items-center justify-start md:justify-center py-3 border-b border-slate-100 relative">
      <a href="/" class="text-2xl font-bold text-slate-900 hover:text-blue-600" aria-label="Simple Calculators Home">
        Simple Calculators
      </a>
      
      <!-- Mobile Menu Button (classic drawer, 90% height, scrollable) -->
      <details id="mobile-nav" class="lg:hidden group z-50 absolute right-0 top-0" aria-label="Main navigation">
        <summary class="flex items-center justify-end w-full p-4 cursor-pointer select-none focus:outline-none" aria-label="Open main menu" role="button" tabindex="0">
          <span class="material-symbols-outlined text-3xl">menu</span>
        </summary>
        <div id="mobile-nav-panel" class="absolute top-full right-0 w-80 max-w-[calc(100vw-2rem)] bg-white shadow-2xl border-l border-gray-200 max-h-[90vh] overflow-y-auto transition-transform duration-200" aria-label="Mobile navigation panel">
          <a
            href="/"
            class={`block px-4 py-3 rounded-md text-base font-medium ${
              currentPath === '/'
                ? 'bg-blue-100 text-blue-700'
                : 'text-slate-700 hover:bg-slate-100'
            }`}
          >
            Home
          </a>
          {topLevelNav.map((category, idx) => (
            <details class="mt-2 mobile-nav-accordion group" data-top-level-index={idx}>
              <summary
                class={`list-none px-4 py-3 rounded-md text-base font-medium cursor-pointer flex items-center justify-between ${
                  isTopLevelCategoryActive(category)
                    ? 'bg-blue-100 text-blue-700'
                    : 'text-slate-700 hover:bg-slate-100'
                }`}
                tabindex="0"
              >
                {category.label}
                <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform duration-300">expand_more</span>
              </summary>
              <div class="mt-2 ml-3 border-l-2 border-blue-200">
                <a
                  href={category.path}
                  class={`block px-4 py-2 text-base font-semibold mb-2 ${
                    isActive(category.path)
                      ? 'bg-blue-50 text-blue-700'
                      : 'text-blue-600 hover:bg-blue-50'
                  }`}
                >
                  View All {category.label}
                </a>
                {category.subcategories.map((subcategory, subIndex) => (
                  <details class="mobile-subcategory group mb-2" data-subcategory-index={subIndex}>
                    <summary class="list-none px-4 py-2 rounded-md text-sm font-semibold text-slate-700 hover:bg-slate-100 cursor-pointer flex items-center justify-between">
                      {subcategory.label}
                      <span class="material-symbols-outlined text-base group-open:rotate-180 transition-transform duration-200">expand_more</span>
                    </summary>
                    <div class="mt-1 mb-2 pl-3 border-l border-slate-200">
                      {subcategory.items.map((item) => (
                        <a
                          href={item.path}
                          class={`block min-h-10 px-4 py-2 text-base leading-snug ${
                            isActive(item.path)
                              ? 'bg-blue-50 text-blue-700 font-semibold'
                              : 'text-slate-700 hover:bg-slate-100'
                          }`}
                        >
                          {item.label}
                        </a>
                      ))}
                    </div>
                  </details>
                ))}
              </div>
            </details>
          ))}
        </div>
        <script type="module">
          document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('mobile-nav');
            if (!root) return;

            const topLevelAccordions = Array.from(root.querySelectorAll('.mobile-nav-accordion'));

            topLevelAccordions.forEach((details, idx) => {
              const summary = details.querySelector('summary');
              if (!summary) return;

              summary.addEventListener('click', (event) => {
                event.preventDefault();
                const shouldOpen = !details.open;
                topLevelAccordions.forEach((accordion) => {
                  accordion.open = false;
                });
                details.open = shouldOpen;
              });

              const subcategoryAccordions = Array.from(details.querySelectorAll('.mobile-subcategory'));

              subcategoryAccordions.forEach((subcategoryDetails) => {
                const subcategorySummary = subcategoryDetails.querySelector('summary');
                if (!subcategorySummary) return;

                subcategorySummary.addEventListener('click', (event) => {
                  event.preventDefault();
                  const shouldOpen = !subcategoryDetails.open;
                  subcategoryAccordions.forEach((accordion) => {
                    accordion.open = false;
                  });
                  subcategoryDetails.open = shouldOpen;
                });
              });
            });

            document.querySelectorAll('[data-desktop-group]').forEach((groupElement) => {
              const tabs = Array.from(groupElement.querySelectorAll('.desktop-subcategory-tab'));
              const panels = Array.from(groupElement.querySelectorAll('.desktop-subcategory-panel'));

              const setActiveTab = (activeIndex) => {
                tabs.forEach((tab) => {
                  const tabIndex = Number(tab.getAttribute('data-sub-index'));
                  const isActive = tabIndex === activeIndex;
                  tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                  tab.classList.toggle('bg-blue-100', isActive);
                  tab.classList.toggle('text-blue-700', isActive);
                  tab.classList.toggle('bg-slate-100', !isActive);
                  tab.classList.toggle('text-slate-700', !isActive);
                  tab.classList.toggle('hover:bg-slate-200', !isActive);
                });

                panels.forEach((panel) => {
                  const panelIndex = Number(panel.getAttribute('data-sub-panel-index'));
                  panel.classList.toggle('hidden', panelIndex !== activeIndex);
                });
              };

              tabs.forEach((tab) => {
                tab.addEventListener('click', () => {
                  const tabIndex = Number(tab.getAttribute('data-sub-index'));
                  setActiveTab(tabIndex);
                });
              });

              setActiveTab(0);
            });

            document.addEventListener('keydown', (event) => {
              if (event.key === 'Escape' && root.open) {
                root.open = false;
              }
            });
          });
        </script>
      </details>
    </div>

    <!-- Navigation Row -->
    <div class="hidden lg:block">
      <ul class="flex justify-center gap-1 text-sm py-2">
        <li>
          <a
            href="/"
            class={`px-4 py-2 h-10 rounded-md font-medium text-sm transition-colors flex items-center gap-1 whitespace-nowrap ${
              currentPath === '/'
                ? 'bg-blue-100 text-blue-700'
                : 'text-slate-600 hover:bg-slate-100'
            }`}
          >
            Home
          </a>
        </li>
        
        {topLevelNav.map((category, index) => (
          <li class="relative group" data-desktop-group>
            <a
              href={category.path}
              class={`px-4 py-2 h-10 rounded-md font-medium text-sm transition-colors flex items-center gap-1 whitespace-nowrap ${
                isTopLevelCategoryActive(category)
                  ? 'bg-blue-100 text-blue-700'
                  : 'text-slate-600 hover:bg-slate-100'
              }`}
            >
              {category.label}
              <span class="material-symbols-outlined text-lg">expand_more</span>
            </a>
            <div
              class={`absolute top-full invisible opacity-0 group-hover:visible group-hover:opacity-100 bg-white border border-slate-200 rounded-md shadow-lg z-20 p-2 transition-opacity duration-150 ${
                index === 0 ? 'left-0' :
                index === 1 ? 'left-1/3 -translate-x-1/3' :
                index === 2 ? 'left-1/2 -translate-x-1/2' :
                index === 3 ? 'left-2/3 -translate-x-2/3' :
                index === 4 ? 'right-0' :
                ''
              }`}
              style={getDesktopDropdownStyle()}
            >
              <div class="flex items-center justify-between gap-3 mb-3">
                <div class="flex flex-wrap gap-2" role="tablist" aria-label={`${category.label} subcategories`}>
                  {category.subcategories.map((subcategory, subIndex) => (
                    <button
                      type="button"
                      class={`desktop-subcategory-tab px-3 py-1.5 rounded-md text-xs font-semibold transition-colors ${
                        subIndex === 0
                          ? 'bg-blue-100 text-blue-700'
                          : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                      }`}
                      role="tab"
                      aria-selected={subIndex === 0 ? 'true' : 'false'}
                      aria-controls={`desktop-subcategory-panel-${index}-${subIndex}`}
                      id={`desktop-subcategory-tab-${index}-${subIndex}`}
                      data-sub-index={subIndex}
                    >
                      {subcategory.label}
                    </button>
                  ))}
                </div>
                <a href={category.path} class="text-xs font-semibold text-blue-700 hover:text-blue-800 whitespace-nowrap">
                  View All
                </a>
              </div>

              {category.subcategories.map((subcategory, subIndex) => (
                <div
                  id={`desktop-subcategory-panel-${index}-${subIndex}`}
                  class={`desktop-subcategory-panel columns-1 md:columns-2 lg:columns-3 [column-gap:0.5rem] ${
                    subIndex === 0 ? '' : 'hidden'
                  }`}
                  role="tabpanel"
                  aria-labelledby={`desktop-subcategory-tab-${index}-${subIndex}`}
                  data-sub-panel-index={subIndex}
                >
                  {subcategory.items.map((item) => (
                    <a
                      href={item.path}
                      class={`block min-h-10 px-4 py-2 text-sm leading-snug transition-colors rounded-md break-inside-avoid mb-1 ${
                        isActive(item.path)
                          ? 'bg-blue-50 text-blue-700 font-semibold'
                          : 'text-slate-700 hover:bg-slate-50'
                      }`}
                    >
                      {item.label}
                    </a>
                  ))}
                </div>
              ))}
            </div>
          </li>
        ))}
      </ul>
    </div>
    <!-- Search Bar Row -->
    <div class="w-full flex justify-center py-2 border-b border-slate-100">
      <div class="w-full max-w-xl">
        <CalculatorSearchBar client:load />
      </div>
    </div>
  </div>
</nav>
