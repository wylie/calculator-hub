---
import CalculatorSearchBar from './CalculatorSearchBar.tsx';
import { generatedCalculators } from '../react-pages/Generated/generatedCalculatorData';

interface NavItem {
  path: string;
  label: string;
}

interface NavCategory {
  label: string;
  path: string;
  items: NavItem[];
}

const currentPath = Astro.url.pathname;

const normalizeLabel = (title: string): string => title.replace(/\s+Calculator$/i, '').trim();

const makeGeneratedItems = (categories: string[]): NavItem[] => {
  return generatedCalculators
    .filter((calculator) => categories.includes(calculator.category))
    .map((calculator) => ({
      path: `/${calculator.slug}`,
      label: normalizeLabel(calculator.title),
    }));
};

const uniqueItems = (items: NavItem[]): NavItem[] => {
  return items.filter((item, index, arr) => arr.findIndex((other) => other.path === item.path) === index);
};

const sortItemsAlphabetically = (items: NavItem[]): NavItem[] => {
  return [...items].sort((left, right) => left.label.localeCompare(right.label, undefined, { sensitivity: 'base' }));
};

const generatedLoansItems = makeGeneratedItems(['loans', 'home']);
const generatedBudgetingItems = makeGeneratedItems(['income']);
const generatedHealthItems = makeGeneratedItems(['health', 'outdoors']);
const generatedSavingsItems = makeGeneratedItems(['savings']);
const generatedConvertersItems = makeGeneratedItems(['percentages', 'time', 'converters']);

const navCategoriesBase: NavCategory[] = [
  {
    label: 'Loans & Real Estate',
    path: '/loans',
    items: [
      { path: '/mortgage', label: 'Mortgage' },
      { path: '/auto-loan', label: 'Auto Loan' },
      { path: '/loan', label: 'Loan' },
      { path: '/loan-affordability', label: 'Loan Affordability' },
      { path: '/refinance', label: 'Refinance' },
      { path: '/down-payment', label: 'Down Payment' },
      { path: '/rent-vs-buy', label: 'Rent vs Buy' },
      { path: '/personal-loan', label: 'Personal Loan' },
      { path: '/student-loan', label: 'Student Loan' },
      { path: '/debt-snowball', label: 'Debt Snowball' },
      { path: '/debt-avalanche', label: 'Debt Avalanche' },
      { path: '/heloc', label: 'HELOC' },
      { path: '/amortization-calculator', label: 'Amortization Schedule' },
      { path: '/loan-payment-calculator', label: 'Loan Payment' },
      { path: '/property-tax', label: 'Property Tax' },
      { path: '/closing-cost', label: 'Closing Cost' },
      { path: '/pmi', label: 'PMI' },
      { path: '/home-equity', label: 'Home Equity' },
      { path: '/rent-increase', label: 'Rent Increase' },
      { path: '/rental-yield', label: 'Rental Yield' },
    ],
  },
  {
    label: 'Savings & Investment',
    path: '/savings-investment',
    items: [
      { path: '/interest', label: 'Interest' },
      { path: '/compound-interest', label: 'Compound Interest' },
      { path: '/investment-growth', label: 'Investment Growth' },
      { path: '/retirement', label: 'Retirement' },
      { path: '/savings', label: 'Savings' },
      { path: '/inflation', label: 'Inflation' },
      { path: '/emergency-fund', label: 'Emergency Fund' },
      { path: '/roi', label: 'ROI' },
    ],
  },
  {
    path: '/budgeting',
    label: 'Budgeting & Finance',
    items: [
      { path: '/budget', label: 'Budget' },
      { path: '/credit-card-payoff', label: 'Credit Card Payoff' },
      { path: '/net-worth', label: 'Net Worth' },
      { path: '/debt-to-income', label: 'Debt-to-Income' },
      { path: '/tax', label: 'Tax' },
      { path: '/salary-hourly', label: 'Salary / Hourly' },
      { path: '/hourly-to-salary', label: 'Hourly to Salary' },
      { path: '/overtime-pay', label: 'Overtime Pay' },
      { path: '/take-home-pay', label: 'Take-Home Pay' },
      { path: '/after-tax-salary', label: 'After-Tax Salary' },
      { path: '/pay-raise', label: 'Pay Raise' },
      { path: '/annual-income', label: 'Annual Income' },
      { path: '/biweekly-pay', label: 'Biweekly Pay' },
      { path: '/monthly-income', label: 'Monthly Income' },
      { path: '/self-employment-tax', label: 'Self-Employment Tax' },
      { path: '/1099-vs-w2', label: '1099 vs W2' },
      { path: '/discount', label: 'Discount / Markup' },
      { path: '/cost-of-living-calculator', label: 'Cost of Living' },
    ],
  },
  {
    path: '/health',
    label: 'Health & Lifestyle',
    items: [
      { path: '/calories', label: 'Calories' },
      { path: '/bmi', label: 'BMI' },
      { path: '/tdee', label: 'TDEE' },
      { path: '/ideal-weight', label: 'Ideal Weight' },
      { path: '/water-intake', label: 'Water Intake' },
      { path: '/protein-intake', label: 'Protein Intake' },
      { path: '/age', label: 'Age' },
      { path: '/tip', label: 'Tip' },
      { path: '/bike-gear', label: 'Bike Gear' },
      { path: '/cycling-power-to-weight', label: 'Power-to-Weight' },
      { path: '/tire-pressure', label: 'Tire Pressure' },
      { path: '/hiking-pace', label: 'Hiking Pace' },
      { path: '/calories-cycling', label: 'Calories Cycling' },
      { path: '/fuel-efficiency', label: 'Fuel Efficiency' },
      { path: '/gpa', label: 'GPA Calculator' },
      { path: '/body-fat', label: 'Body Fat' },
      { path: '/lean-body-mass', label: 'Lean Body Mass' },
      { path: '/macro-calculator', label: 'Macro' },
      { path: '/calories-burned', label: 'Calories Burned' },
      { path: '/one-rep-max', label: 'One Rep Max' },
      { path: '/target-heart-rate', label: 'Target Heart Rate' },
      { path: '/cycling-ftp', label: 'Cycling FTP' },
      { path: '/vo2-max', label: 'VO2 Max' },
      { path: '/trail-elevation-gain', label: 'Trail Elevation Gain' },
      { path: '/pace-per-mile', label: 'Pace Per Mile' },
    ],
  },
  {path: '/converters',
    
    label: 'Converters & Tools',
    items: [
      { path: '/weather', label: 'Temperature' },
      { path: '/weight', label: 'Weight' },
      { path: '/height-converter', label: 'Height' },
      { path: '/distance-converter', label: 'Distance' },
      { path: '/length', label: 'Length' },
      { path: '/speed', label: 'Speed' },
      { path: '/volume', label: 'Volume' },
      { path: '/area', label: 'Area' },
      { path: '/time', label: 'Time' },
      { path: '/time-duration', label: 'Time Duration' },
      { path: '/cooking-converter', label: 'Cooking' },
      { path: '/power-converter', label: 'Power' },
      { path: '/file-size', label: 'File Size' },
      { path: '/percentage', label: 'Percentage' },
      { path: '/percentage-of-a-number', label: 'Percentage of a Number' },
      { path: '/what-percent-of-x-is-y', label: 'What Percent of X is Y' },
      { path: '/fraction-to-percent', label: 'Fraction to Percent' },
      { path: '/percent-to-fraction', label: 'Percent to Fraction' },
      { path: '/margin-calculator', label: 'Margin' },
      { path: '/markup-calculator', label: 'Markup' },
      { path: '/percentage-increase', label: 'Percentage Increase' },
      { path: '/percentage-decrease', label: 'Percentage Decrease' },
      { path: '/percent-change', label: 'Percent Change' },
      { path: '/date-difference', label: 'Date Difference' },
      { path: '/work-hours', label: 'Work Hours' },
      { path: '/business-days', label: 'Business Days' },
      { path: '/countdown', label: 'Countdown' },
      { path: '/week-number', label: 'Week Number' },
      { path: '/time-zone-converter', label: 'Time Zone Converter' },
      { path: '/climbing-grade-converter', label: 'Climbing Grade Converter' },
    ],
  },
];

const navCategories: NavCategory[] = navCategoriesBase.map((category) => {
  let generatedItems: NavItem[] = [];

  if (category.path === '/loans') {
    generatedItems = generatedLoansItems;
  } else if (category.path === '/budgeting') {
    generatedItems = generatedBudgetingItems;
  } else if (category.path === '/health') {
    generatedItems = generatedHealthItems;
  } else if (category.path === '/savings-investment') {
    generatedItems = generatedSavingsItems;
  } else if (category.path === '/converters') {
    generatedItems = generatedConvertersItems;
  }

  return {
    ...category,
    items: sortItemsAlphabetically(uniqueItems([...category.items, ...generatedItems])),
  };
});

const isActive = (path: string) => currentPath === path;
const isCategoryActive = (items: NavItem[]) => items.some((item) => isActive(item.path));

const getDesktopDropdownColumns = (): number => 3;

const getDesktopDropdownStyle = (): string => {
  const columns = getDesktopDropdownColumns();
  const columnWidth = 220;
  const width = columns * columnWidth;
  return `display: grid; grid-template-columns: repeat(${columns}, ${columnWidth}px); gap: 0.5rem; width: min(${width}px, calc(100vw - 2rem)); max-width: calc(100vw - 2rem); max-height: min(80vh, 700px); overflow-y: auto; overflow-x: hidden;`;
};
---

<nav class="bg-white border-b border-slate-200 shadow-sm">
  <div class="max-w-7xl mx-auto px-6">
    <!-- Site Name Row -->
    <div class="flex items-center justify-start md:justify-center py-3 border-b border-slate-100 relative">
      <a href="/" class="text-2xl font-bold text-slate-900 hover:text-blue-600" aria-label="Simple Calculators Home">
        Simple Calculators
      </a>
      
      <!-- Mobile Menu Button (classic drawer, 90% height, scrollable) -->
      <details id="mobile-nav" class="lg:hidden group z-50 absolute right-0 top-0" aria-label="Main navigation">
        <summary class="flex items-center justify-end w-full p-4 cursor-pointer select-none focus:outline-none" aria-label="Open main menu" role="button" tabindex="0">
          <span class="material-symbols-outlined text-3xl">menu</span>
        </summary>
        <div id="mobile-nav-panel" class="absolute top-full right-0 w-80 max-w-[calc(100vw-2rem)] bg-white shadow-2xl border-l border-gray-200 max-h-[90vh] overflow-y-auto transition-transform duration-200" aria-label="Mobile navigation panel">
          <a
            href="/"
            class={`block px-4 py-3 rounded-md text-base font-medium ${
              currentPath === '/'
                ? 'bg-blue-100 text-blue-700'
                : 'text-slate-700 hover:bg-slate-100'
            }`}
          >
            Home
          </a>
          {navCategories.map((category, idx) => (
            <details class="mt-2 mobile-nav-accordion group" data-idx={idx}>
              <summary
                class={`list-none px-4 py-3 rounded-md text-base font-medium cursor-pointer flex items-center justify-between ${
                  isActive(category.path) || isCategoryActive(category.items)
                    ? 'bg-blue-100 text-blue-700'
                    : 'text-slate-700 hover:bg-slate-100'
                }`}
                tabindex="0"
              >
                {category.label}
                <span class="material-symbols-outlined text-lg group-open:rotate-180 transition-transform duration-300">expand_more</span>
              </summary>
              <div class="mt-2 ml-3 border-l-2 border-blue-200">
                <a
                  href={category.path}
                  class={`block px-4 py-2 text-base font-semibold ${
                    isActive(category.path)
                      ? 'bg-blue-50 text-blue-700'
                      : 'text-blue-600 hover:bg-blue-50'
                  }`}
                >
                  View All {category.label}
                </a>
                {category.items.map((item) => (
                  <a
                    href={item.path}
                    class={`block min-h-10 px-4 py-2 text-base leading-snug ${
                      isActive(item.path)
                        ? 'bg-blue-50 text-blue-700 font-semibold'
                        : 'text-slate-700 hover:bg-slate-100'
                    }`}
                  >
                    {item.label}
                  </a>
                ))}
              </div>
            </details>
          ))}
        </div>
        <script type="module">
          document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('mobile-nav');
            if (!root) return;
            // Accordion logic
            root.querySelectorAll('.mobile-nav-accordion').forEach((details, idx, all) => {
              const summary = details.querySelector('summary');
              summary.addEventListener('click', (e) => {
                e.preventDefault();
                all.forEach((el, i) => {
                  el.open = (i === idx) ? !details.open : false;
                });
              });
            });
            // Escape key closes mobile nav
            document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape' && root.open) {
                root.open = false;
              }
            });
          });
        </script>
      </details>
    </div>

    <!-- Navigation Row -->
    <div class="hidden lg:block">
      <ul class="flex justify-center gap-1 text-sm py-2">
        <li>
          <a
            href="/"
            class={`px-4 py-2 h-10 rounded-md font-medium text-sm transition-colors flex items-center gap-1 whitespace-nowrap ${
              currentPath === '/'
                ? 'bg-blue-100 text-blue-700'
                : 'text-slate-600 hover:bg-slate-100'
            }`}
          >
            Home
          </a>
        </li>
        
        {navCategories.map((category, index) => (
          <li class="relative group">
            <a
              href={category.path}
              class={`px-4 py-2 h-10 rounded-md font-medium text-sm transition-colors flex items-center gap-1 whitespace-nowrap ${
                isActive(category.path) || isCategoryActive(category.items)
                  ? 'bg-blue-100 text-blue-700'
                  : 'text-slate-600 hover:bg-slate-100'
              }`}
            >
              {category.label}
              <span class="material-symbols-outlined text-lg">expand_more</span>
            </a>
            <div
              class={`absolute top-full invisible opacity-0 group-hover:visible group-hover:opacity-100 bg-white border border-slate-200 rounded-md shadow-lg z-20 p-2 transition-opacity duration-150 ${
                index === 0 ? 'left-0' :
                index === 1 ? 'left-1/3 -translate-x-1/3' :
                index === 2 ? 'left-1/2 -translate-x-1/2' :
                index === 3 ? 'left-2/3 -translate-x-2/3' :
                index === 4 ? 'right-0' :
                ''
              }`}
              style={getDesktopDropdownStyle()}
            >
              {category.items.map((item) => (
                <a
                  href={item.path}
                  class={`block min-h-10 px-4 py-2 text-sm leading-snug transition-colors rounded-md break-inside-avoid mb-1 ${
                    isActive(item.path)
                      ? 'bg-blue-50 text-blue-700 font-semibold'
                      : 'text-slate-700 hover:bg-slate-50'
                  }`}
                >
                  {item.label}
                </a>
              ))}
            </div>
          </li>
        ))}
      </ul>
    </div>
    <!-- Search Bar Row -->
    <div class="w-full flex justify-center py-2 border-b border-slate-100">
      <div class="w-full max-w-xl">
        <CalculatorSearchBar client:load />
      </div>
    </div>
  </div>
</nav>
